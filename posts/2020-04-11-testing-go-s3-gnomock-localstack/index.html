<!DOCTYPE html>

<html lang="en-us">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Testing Go&#43;S3 with Gnomock and Localstack &middot; Yury Fedorov (@orlangure)</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Testing Go&#43;S3 with Gnomock and Localstack"/>
    <meta property="og:description" content="Leveraging Gnomock&#43;Localstack to test Go program that uses S3 heavily"/>
    <meta property="og:site_name" content="Yury Fedorov (@orlangure)"/>
    <meta property="og:url" content="https://fedorov.dev/posts/2020-04-11-testing-go-s3-gnomock-localstack/"/>
    <meta property="og:locale" content="en">
    
    <meta property="og:type" content="website"/>

    
    
    
    <link rel="stylesheet" href="https://fedorov.dev/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-121619561-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>

</head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">Yury Fedorov (@orlangure)</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="/about/">About</a>
  
    <a class="color-link nav-link" href="/tags/">Tags</a>
  
    <a class="color-link nav-link" href="/archives/">Archives</a>
  
  <a class="color-link nav-link" href="https://fedorov.dev/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://www.linkedin.com/in/yury-fedorov/" target="_blank" rel="noopener" title="LinkedIn">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M2,3.654102 C2,2.69908141 2.79442509,1.92397846 3.77383592,1.92397846 L24.2261641,1.92397846 C25.2058917,1.92397846 26,2.69908141 26,3.654102 L26,24.3462148 C26,25.3015521 25.2058917,26.0760215 24.2261641,26.0760215 L3.77383592,26.0760215 C2.79442509,26.0760215 2,25.3015521 2,24.3465315 L2,3.65378524 L2,3.654102 Z M9.27526132,22.1415901 L9.27526132,11.2356668 L5.65030092,11.2356668 L5.65030092,22.1415901 L9.27557808,22.1415901 L9.27526132,22.1415901 Z M7.46341463,9.74691162 C8.72727273,9.74691162 9.51409566,8.90940767 9.51409566,7.86284447 C9.49033893,6.79252455 8.72727273,5.97846056 7.48748812,5.97846056 C6.24675325,5.97846056 5.43649034,6.79252455 5.43649034,7.86284447 C5.43649034,8.90940767 6.22299652,9.74691162 7.4396579,9.74691162 L7.46309788,9.74691162 L7.46341463,9.74691162 Z M11.2815965,22.1415901 L14.9062401,22.1415901 L14.9062401,16.0519481 C14.9062401,15.7263225 14.9299968,15.4000634 15.0256573,15.1675641 C15.2876148,14.5159962 15.8840672,13.8416218 16.8856509,13.8416218 C18.1970225,13.8416218 18.7218879,14.8416218 18.7218879,16.3078872 L18.7218879,22.1415901 L22.3465315,22.1415901 L22.3465315,15.8885017 C22.3465315,12.5388027 20.5584416,10.9800443 18.1735825,10.9800443 C16.2182452,10.9800443 15.3595185,12.072854 14.8824834,12.8172315 L14.9065569,12.8172315 L14.9065569,11.2359835 L11.2819132,11.2359835 C11.3291099,12.2591067 11.2815965,22.1419069 11.2815965,22.1419069 L11.2815965,22.1415901 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/orlangure" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="https://stackoverflow.com/users/4378400/yury-fedorov" target="_blank" rel="noopener" title="Stack Overflow">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M20.8863636,23.7090909 L20.8863636,17.3818182 L22.9863636,17.3818182 L22.9863636,25.8090909 L4.03181818,25.8090909 L4.03181818,17.3818182 L6.13181818,17.3818182 L6.13181818,23.7090909 L20.8863636,23.7090909 Z M8.45,16.7818182 L8.88636364,14.7090909 L19.1954545,16.8636364 L18.7590909,18.9363636 L8.45,16.7818182 Z M9.81363636,11.8727273 L10.6863636,9.93636364 L20.2318182,14.4090909 L19.3590909,16.3181818 L9.81363636,11.8727273 Z M12.4590909,7.18181818 L13.7954545,5.57272727 L21.8954545,12.3090909 L20.5590909,13.9181818 L12.4590909,7.18181818 Z M17.6954545,2.19090909 L23.9681818,10.6454545 L22.2772727,11.9 L16.0045455,3.44545455 L17.6954545,2.19090909 Z M8.23181818,21.5818182 L8.23181818,19.4818182 L18.7590909,19.4818182 L18.7590909,21.5818182 L8.23181818,21.5818182 Z"></path>
        </svg>
    </a>
    
    
    

    

    

    

    

</div>




	<script src="https://fedorov.dev/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>

</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">Testing Go&#43;S3 with Gnomock and Localstack</h1>
    
    <time>April 11, 2020</time>
    
    <div>
        <p>
        <p>A few months ago I built <a href="https://github.com/orlangure/gompress">gompress</a>: a
simple utility that takes a location in AWS S3, compresses all the files in it
with GZIP, and puts them in another location, also in S3, optionally keeping or
removing the original files. It was something I wrote to use once on a large S3
bucket full of uncompressed CSV files, and published it for anyone else who
might need it. Although all worked well, there was something that made me
uncomfortable about it: it didn&rsquo;t have any tests.</p>
<p>There were two reasons for not adding tests. One, and obvious, was that it
wasn&rsquo;t worth the time as I needed a quick solution of a specific problem I
faced. The other one was that it was not easy to write a test to a program that
operates entirely on a 3rd party service, such as AWS S3. Even though there
were ways to mock the service, I felt that these tests will never be good
enough.</p>
<blockquote>
<p>The original version of the code can be found
<a href="https://github.com/orlangure/gompress/tree/v0.1.2">here</a>.</p>
</blockquote>
<p>Recently, after I created <a href="https://github.com/orlangure/gnomock">Gnomock</a>, an
<strong>integration and end-to-end testing toolkit</strong> that uses external services
without mocking them, I decided to use it to test
<a href="https://github.com/orlangure/gompress">gompress</a> as well.</p>
<h2 id="localstack-preset">Localstack preset</h2>
<p><a href="https://github.com/localstack/localstack">Localstack</a> is an very popular
project that allows to <strong>spin up many AWS services, including S3, locally,
using a single docker container</strong>. To be used in Go tests, it needs to be
wrapped with some code that allows to pull the image, start the container,
setup port bindings, wait for the services to become available and setup some
initial state, all before starting to actually verify whatever the program
does. These actions are repeated for every package that uses S3, so I
implemented a new
<a href="https://github.com/orlangure/gnomock/tree/master/preset/localstack">preset</a>
for Gnomock. This preset can be reused anywhere very easily, and here is how.</p>
<h2 id="implementation">Implementation</h2>
<h3 id="getting-the-dependencies">Getting the dependencies</h3>
<p>First of all, <code>go get</code> the package:</p>
<pre><code>$ go get github.com/orlangure/gnomock
</code></pre><h3 id="preparing-the-code">Preparing the code</h3>
<blockquote>
<p>You can skip this part, and go directly to the <a href="#preparing-test-data">actual
testing</a></p>
</blockquote>
<p>Since I originally wrote the code without thinking about its testability, it
wasn&rsquo;t really possible to test anything easily. There were a few problems:</p>
<h4 id="moving-execution-to-sub-package">Moving execution to sub-package</h4>
<p>Actual execution code was originally inside <code>main</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">conf</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newConfig</span>()
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">src</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newClient</span>(<span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">srcRegion</span>, <span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">srcBucket</span>, <span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">srcPrefix</span>)
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dst</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newClient</span>(<span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">dstRegion</span>, <span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">dstBucket</span>, <span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">dstPrefix</span>)
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">files</span>, <span style="color:#a6e22e">errors</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">src</span>.<span style="color:#a6e22e">listFiles</span>()
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">w</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">worker</span>{<span style="color:#a6e22e">src</span>, <span style="color:#a6e22e">dst</span>, <span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">keepOriginal</span>}
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">start</span>(<span style="color:#a6e22e">files</span>, <span style="color:#a6e22e">wg</span>)
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><p>Even though it worked, this code was hard to test: I needed to actually run the
program to trigger whatever actions were taken by it. Such tests won&rsquo;t benefit
from Go&rsquo;s coverage reports, race detector, or debugging.  That&rsquo;s how all the
application logic moved to <code>gompress</code> package inside <code>gompress</code> repository.
From that point forward, <code>main</code> included only configuration using
<a href="https://golang.org/pkg/flag/"><code>flag</code></a> package, and a call to
<a href="https://github.com/orlangure/gompress/blob/0a02e95787ad02609511dd8c628c3b9f3b7112c2/gompress/gompress.go#L13"><code>gompress.Run</code></a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">conf</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newConfig</span>()
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">gompress</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">conf</span>)
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><h4 id="s3-endpoint-configuration">S3 Endpoint configuration</h4>
<p>The next step was to <strong>instruct AWS SDK to use a custom endpoint</strong> whenever it
needed to access S3. <code>Config</code> type was made public, and it got a new field:
<code>Endpoint</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Config defines how gompress will process the files
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Config</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// Endpoint is used for tests to override default s3 endpoint
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Endpoint</span> <span style="color:#66d9ef">string</span>
}
</code></pre></div><p>This new field was used every time the code created a new AWS session:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">config</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">Config</span>{<span style="color:#a6e22e">Region</span>: <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;us-east-1&#34;</span>)}

<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">endpoint</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Endpoint</span> = <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">endpoint</span>)
	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">S3ForcePathStyle</span> = <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">Bool</span>(<span style="color:#66d9ef">true</span>)
}

<span style="color:#a6e22e">sess</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">NewSession</span>(<span style="color:#a6e22e">config</span>)
<span style="color:#75715e">// ...
</span></code></pre></div><p>Here, two AWS SDK for Go parameters are used:
<a href="https://docs.aws.amazon.com/sdk-for-go/api/aws/#Config"><code>Endpoint</code></a>, which is
an address of S3 service, and
<a href="https://docs.aws.amazon.com/sdk-for-go/api/aws/#Config"><code>S3ForcePathStyle</code></a>,
which makes sure AWS SDK <strong>does not</strong> use custom domain names for every bucket,
and appends bucket names to the URL instead.</p>
<p>So, in order to properly test the code, I needed to change both the structure
of the code and the actual &ldquo;production&rdquo; code (S3 client configuration).</p>
<h3 id="preparing-test-data">Preparing test data</h3>
<p><code>gompress</code> is used on buckets with lots of uncompressed files. So, before
writing actual test code, I needed to create the files for it. All the files
can be found in
<a href="https://github.com/orlangure/gompress/tree/master/gompress/testdata"><code>testdata</code></a>
folder. There are 200 files with some random base64 contents, created with the
following commands:</p>
<pre><code>$ for i in `seq 100`; do openssl rand -base64 -out testdata/input-bucket/a-$i.txt 1000; done
$ for i in `seq 100`; do openssl rand -base64 -out testdata/input-bucket/b-$i.txt 1000; done
</code></pre><p>All the files were put into <code>input-bucket</code> folder, which later will be
translated to a new S3 bucket.</p>
<h3 id="setting-up-localstack">Setting up localstack</h3>
<p>Finally, I was able to start writing the <a href="https://github.com/orlangure/gompress/blob/v0.1.2/gompress/gompress_test.go">test
itself</a>.
First, I needed a running instance of localstack, with all my test files
already inside it. It was an easy task with
<a href="https://github.com/orlangure/gnomock">gnomock</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// create empty folder for output bucket
</span><span style="color:#75715e"></span><span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">MkdirAll</span>(<span style="color:#e6db74">&#34;./testdata/output-bucket&#34;</span>, <span style="color:#ae81ff">0755</span>)
<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// use gnomock-localstack preset to spin up S3
</span><span style="color:#75715e"></span><span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">localstack</span>.<span style="color:#a6e22e">Preset</span>(
	<span style="color:#a6e22e">localstack</span>.<span style="color:#a6e22e">WithServices</span>(<span style="color:#a6e22e">localstack</span>.<span style="color:#a6e22e">S3</span>),
	<span style="color:#a6e22e">localstack</span>.<span style="color:#a6e22e">WithS3Files</span>(<span style="color:#e6db74">&#34;./testdata&#34;</span>),
)
<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gnomock</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">p</span>)

<span style="color:#75715e">// clean up after we are done
</span><span style="color:#75715e"></span><span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() { <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">gnomock</span>.<span style="color:#a6e22e">Stop</span>(<span style="color:#a6e22e">c</span>) }()

<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// local s3 service is now accessible:
</span><span style="color:#75715e"></span><span style="color:#a6e22e">s3Endpoint</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;http://%s/&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Address</span>(<span style="color:#a6e22e">localstack</span>.<span style="color:#a6e22e">S3Port</span>))
</code></pre></div><p><code>testdata</code> folder already included <code>input-bucket</code> directory, and I needed to
create an empty <code>output-bucket</code> folder so that <code>gnomock</code> will recreate this
structure in S3: one bucket for the input, with all the files, and the other
one for the output, empty.</p>
<p>Gnomock Localstack preset allows to recreate a local folder structure in S3,
running locally using localstack. All it needs is a
<a href="https://pkg.go.dev/github.com/orlangure/gnomock@v0.9.0/preset/localstack?tab=doc#WithS3Files"><code>localstack.WithS3Files</code></a>
option with a root directory of the required S3 state. Every direct child
folder will be used as a bucket, and all its files will be uploaded into it,
keeping the relative paths.</p>
<p><code>gnomock.Start(p)</code> call is blocking until the container is up, running, and
includes all the files I wanted it to have.</p>
<p>With that, I created a new S3 client using AWS SDK and the local container:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">config</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">Config</span>{
	<span style="color:#a6e22e">Region</span>:           <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">region</span>),
	<span style="color:#a6e22e">Endpoint</span>:         <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">s3Endpoint</span>),
	<span style="color:#a6e22e">S3ForcePathStyle</span>: <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">Bool</span>(<span style="color:#66d9ef">true</span>),
	<span style="color:#a6e22e">Credentials</span>:      <span style="color:#a6e22e">credentials</span>.<span style="color:#a6e22e">NewStaticCredentials</span>(<span style="color:#e6db74">&#34;a&#34;</span>, <span style="color:#e6db74">&#34;b&#34;</span>, <span style="color:#e6db74">&#34;c&#34;</span>),
}

<span style="color:#a6e22e">sess</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">NewSession</span>(<span style="color:#a6e22e">config</span>)
<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">svc</span> = <span style="color:#a6e22e">s3</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">sess</span>)
</code></pre></div><h3 id="actual-testing">Actual testing</h3>
<p>With S3 service running locally in a container, with all the files already
inside, I started writing the actual test. First, I needed to confirm that the
original state was as I expected:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// start with 200 files
</span><span style="color:#75715e"></span><span style="color:#a6e22e">listInput</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s3</span>.<span style="color:#a6e22e">ListObjectsV2Input</span>{<span style="color:#a6e22e">Bucket</span>: <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">inputBucket</span>)}
<span style="color:#a6e22e">files</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">ListObjectsV2</span>(<span style="color:#a6e22e">listInput</span>)
<span style="color:#a6e22e">require</span>.<span style="color:#a6e22e">NoError</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)
<span style="color:#a6e22e">require</span>.<span style="color:#a6e22e">Len</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">Contents</span>, <span style="color:#ae81ff">200</span>)
</code></pre></div><p>Then, I needed to actually run the code against this S3 service:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">conf</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">gompress</span>.<span style="color:#a6e22e">Config</span>{
	<span style="color:#a6e22e">Src</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">gompress</span>.<span style="color:#a6e22e">S3Locaction</span>{
		<span style="color:#a6e22e">Region</span>: <span style="color:#a6e22e">region</span>,
		<span style="color:#a6e22e">Bucket</span>: <span style="color:#a6e22e">inputBucket</span>,
		<span style="color:#a6e22e">Prefix</span>: <span style="color:#e6db74">&#34;a-&#34;</span>,
	},
	<span style="color:#a6e22e">Dst</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">gompress</span>.<span style="color:#a6e22e">S3Locaction</span>{
		<span style="color:#a6e22e">Region</span>: <span style="color:#a6e22e">region</span>,
		<span style="color:#a6e22e">Bucket</span>: <span style="color:#a6e22e">outputBucket</span>,
		<span style="color:#a6e22e">Prefix</span>: <span style="color:#e6db74">&#34;new-dir/&#34;</span>,
	},
	<span style="color:#a6e22e">KeepOriginal</span>: <span style="color:#66d9ef">false</span>, <span style="color:#75715e">// remove original files from s3
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Endpoint</span>:	 <span style="color:#a6e22e">s3Endpoint</span>,
}

<span style="color:#a6e22e">require</span>.<span style="color:#a6e22e">NoError</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Setenv</span>(<span style="color:#e6db74">&#34;AWS_ACCESS_KEY_ID&#34;</span>, <span style="color:#e6db74">&#34;foo&#34;</span>))
<span style="color:#a6e22e">require</span>.<span style="color:#a6e22e">NoError</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Setenv</span>(<span style="color:#e6db74">&#34;AWS_SECRET_ACCESS_KEY&#34;</span>, <span style="color:#e6db74">&#34;bar&#34;</span>))
<span style="color:#a6e22e">require</span>.<span style="color:#a6e22e">NoError</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">gompress</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">conf</span>))
</code></pre></div><p>Note the AWS credentials environment variables: the original code uses these
credentials to connect, but in tests they don&rsquo;t have to be even close to real
credentials.</p>
<p>You can see the rest of the code in the <a href="https://github.com/orlangure/gompress/blob/v0.1.2/gompress/gompress_test.go">test
file</a>,
but there is nothing new: I use AWS SDK for Go to list and read files from S3
(running locally) to verify that that code did what I expected.</p>
<h2 id="summary">Summary</h2>
<p>I didn&rsquo;t add any tests to a program I wrote once because there was no way to do
so that I found good enough. Later,
<a href="https://github.com/orlangure/gnomock">gnomock</a> made it possible: it was very
easy to spin up S3 service locally, directly from my test code in Go, set up
its initial state using one line of code, and run the tests against a real S3
service without any mocks.</p>

        </p>
    </div>
    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="/tags/go">#go</a>
        
            <a class="tag" href="/tags/docker">#docker</a>
        
            <a class="tag" href="/tags/gnomock">#gnomock</a>
        
            <a class="tag" href="/tags/oss">#oss</a>
        
            <a class="tag" href="/tags/localstack">#localstack</a>
        
            <a class="tag" href="/tags/aws">#aws</a>
        
            <a class="tag" href="/tags/s3">#s3</a>
        
            <a class="tag" href="/tags/testing">#testing</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="/css/katex.min.css">
<script type="text/javascript" src="/js/katex.min.js"></script>
<script type="text/javascript" src="/js/auto-render.min.js"onload="renderMathInElement(document.body);"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://www.linkedin.com/in/yury-fedorov/" target="_blank" rel="noopener" title="LinkedIn">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M2,3.654102 C2,2.69908141 2.79442509,1.92397846 3.77383592,1.92397846 L24.2261641,1.92397846 C25.2058917,1.92397846 26,2.69908141 26,3.654102 L26,24.3462148 C26,25.3015521 25.2058917,26.0760215 24.2261641,26.0760215 L3.77383592,26.0760215 C2.79442509,26.0760215 2,25.3015521 2,24.3465315 L2,3.65378524 L2,3.654102 Z M9.27526132,22.1415901 L9.27526132,11.2356668 L5.65030092,11.2356668 L5.65030092,22.1415901 L9.27557808,22.1415901 L9.27526132,22.1415901 Z M7.46341463,9.74691162 C8.72727273,9.74691162 9.51409566,8.90940767 9.51409566,7.86284447 C9.49033893,6.79252455 8.72727273,5.97846056 7.48748812,5.97846056 C6.24675325,5.97846056 5.43649034,6.79252455 5.43649034,7.86284447 C5.43649034,8.90940767 6.22299652,9.74691162 7.4396579,9.74691162 L7.46309788,9.74691162 L7.46341463,9.74691162 Z M11.2815965,22.1415901 L14.9062401,22.1415901 L14.9062401,16.0519481 C14.9062401,15.7263225 14.9299968,15.4000634 15.0256573,15.1675641 C15.2876148,14.5159962 15.8840672,13.8416218 16.8856509,13.8416218 C18.1970225,13.8416218 18.7218879,14.8416218 18.7218879,16.3078872 L18.7218879,22.1415901 L22.3465315,22.1415901 L22.3465315,15.8885017 C22.3465315,12.5388027 20.5584416,10.9800443 18.1735825,10.9800443 C16.2182452,10.9800443 15.3595185,12.072854 14.8824834,12.8172315 L14.9065569,12.8172315 L14.9065569,11.2359835 L11.2819132,11.2359835 C11.3291099,12.2591067 11.2815965,22.1419069 11.2815965,22.1419069 L11.2815965,22.1415901 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/orlangure" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="https://stackoverflow.com/users/4378400/yury-fedorov" target="_blank" rel="noopener" title="Stack Overflow">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M20.8863636,23.7090909 L20.8863636,17.3818182 L22.9863636,17.3818182 L22.9863636,25.8090909 L4.03181818,25.8090909 L4.03181818,17.3818182 L6.13181818,17.3818182 L6.13181818,23.7090909 L20.8863636,23.7090909 Z M8.45,16.7818182 L8.88636364,14.7090909 L19.1954545,16.8636364 L18.7590909,18.9363636 L8.45,16.7818182 Z M9.81363636,11.8727273 L10.6863636,9.93636364 L20.2318182,14.4090909 L19.3590909,16.3181818 L9.81363636,11.8727273 Z M12.4590909,7.18181818 L13.7954545,5.57272727 L21.8954545,12.3090909 L20.5590909,13.9181818 L12.4590909,7.18181818 Z M17.6954545,2.19090909 L23.9681818,10.6454545 L22.2772727,11.9 L16.0045455,3.44545455 L17.6954545,2.19090909 Z M8.23181818,21.5818182 L8.23181818,19.4818182 L18.7590909,19.4818182 L18.7590909,21.5818182 L8.23181818,21.5818182 Z"></path>
        </svg>
    </a>
    
    
    

    

    

    

    

</div>




	<script src="https://fedorov.dev/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>

    </body>
</html>